"use strict";var n=function(){function n(n){this.string=n;for(var e=[0],t=0;t<n.length;)switch(n[t]){case"\n":t+="\n".length,e.push(t);break;case"\r":"\n"===n[t+="\r".length]&&(t+="\n".length),e.push(t);break;default:t++}this.offsets=e}return n.prototype.locationForIndex=function(n){if(n<0||n>this.string.length)return null;for(var e=0,t=this.offsets;t[e+1]<=n;)e++;return{line:e,column:n-t[e]}},n.prototype.indexForLocation=function(n){var e=n.line,t=n.column;return e<0||e>=this.offsets.length||t<0||t>this.lengthOfLine(e)?null:this.offsets[e]+t},n.prototype.lengthOfLine=function(n){var e=this.offsets[n];return(n===this.offsets.length-1?this.string.length:this.offsets[n+1])-e},n}();const e=(n,e)=>({begin:new RegExp(`${n}[ \t]*?#(ifdef|ifndef)[ \t]*?(.+?)${e}`,"g"),end:new RegExp(`${n}[ \t]*?#(endif)[ \t]*?${e}`,"g")}),t=/\s*\|\|\s*/,i={line:e("\\/\\/!?","(?=$|\\n|\\r\\n)"),block:e("\\/\\*!?","\\*\\/"),xml:e("<\\!--","--\x3e")},o=(e,t,i)=>{const o=new n(e).locationForIndex(t);throw new Error(`${i}${o?`，位置: 第${o.line}行，第${o.column}列`:""}`)},s=n=>" ".repeat(n.length),c=()=>"",l=/[^\r\n\t ]/g;function r(n,e,i,o){const{code:s,options:{keepMismatch:c},conditionSet:f}=n;if(0===e.length)return s.slice(i,o);let h="";const d=e[0];d.begin!==i&&(h+=s.slice(i,d.begin)),e.forEach(((i,o)=>{const d=e[o-1];d&&d.end!==i.begin&&(h+=s.slice(d.end,i.begin));let g=i.condition.trim().split(t).some((n=>f.has(n)));"ifndef"===i.type&&(g=!g),g?i.children&&0!==i.children.length?h+=r(n,i.children,i.begin,i.end):h+=s.slice(i.begin,i.end):c&&(h+=s.slice(i.begin,i.end).replace(l," "))}));const g=e[e.length-1];return g.end!==o&&(h+=s.slice(g.end,o)),h}function f(n){const{code:e,commentRegs:t}=n,i=[...e.matchAll(t.begin),...e.matchAll(t.end)].sort(((n,e)=>n.index-e.index)),l=[],f=[];for(let n=0;n<i.length;n+=1){const[t,s,c]=i[n],r=i[n].index;if("ifdef"===s||"ifndef"===s)l.push({type:s,condition:c,begin:r,end:r});else if("endif"===s)if(l.length>0){const n=l.pop();if(n.end=r+t.length,0===l.length)f.push(n);else{const e=l[l.length-1];(e.children||(e.children=[])).push(n)}}else o(e,r,"未找到对应的 ifdef/ifndef");else o(e,r,`未知类型 ${s}`)}return function(n,e){const{commentRegs:t,options:{keepMismatch:i}}=n,o=i?s:c;return e.replace(t.begin,o).replace(t.end,o)}(n,r(n,f,0,e.length))}module.exports=(n,e)=>{e.conditions||(e.conditionals?console.warn("请使用 conditions 代替 conditionals"):console.warn("请提供 conditions"));const t=i[e.commentType];if(!t)throw new Error(`未知的条件编译注释类型: ${e.commentType}`);return f({code:n,options:e,commentRegs:t,conditionSet:new Set(e.conditions||e.conditionals)})};
